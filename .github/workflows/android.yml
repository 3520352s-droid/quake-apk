name: Build Android APK (Buildozer)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Java 17 (нужен actions/setup-android и современным компонентам)
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git zip unzip \
            build-essential \
            autoconf automake libtool pkg-config \
            cmake \
            zlib1g-dev \
            libffi-dev libssl-dev \
            python3-dev \
            libjpeg-dev \
            libsqlite3-dev \
            libncurses6 \
            libbz2-dev liblzma-dev

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        run: |
          SDK=/usr/local/lib/android/sdk
          yes | $SDK/cmdline-tools/latest/bin/sdkmanager --licenses
          $SDK/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-33" \
            "build-tools;33.0.2" \
            "ndk;25.2.9519653"

      # ВАЖНО: Java 8 для python-for-android / старых частей тулчейна
      - name: Set up Java 8 (for Buildozer)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "8"

      - name: Install latest Buildozer + python-for-android
        run: |
          python -m pip install --upgrade pip
          pip install Cython==0.29.36
          pip install "buildozer @ git+https://github.com/kivy/buildozer.git"
          pip install "python-for-android @ git+https://github.com/kivy/python-for-android.git"

      - name: Force buildozer verbose + log_level=2 + set SDK/NDK paths
        run: |
          # Если buildozer.spec есть — правим его.
          # Если нет — buildozer сам создаст, но лучше чтобы он был.
          if [ -f buildozer.spec ]; then
            # log_level = 2
            if grep -q "^log_level" buildozer.spec; then
              sed -i 's/^log_level.*/log_level = 2/' buildozer.spec
            else
              echo "log_level = 2" >> buildozer.spec
            fi

            # Одну архитектуру для дебага (потом вернем armeabi-v7a)
            if grep -q "^android.arch" buildozer.spec; then
              sed -i 's/^android\.arch.*/android.arch = arm64-v8a/' buildozer.spec
            else
              echo "android.arch = arm64-v8a" >> buildozer.spec
            fi

            # Явно укажем пути SDK/NDK, чтобы не было путаницы
            if grep -q "^android.sdk_path" buildozer.spec; then
              sed -i 's|^android\.sdk_path.*|android.sdk_path = /usr/local/lib/android/sdk|' buildozer.spec
            else
              echo "android.sdk_path = /usr/local/lib/android/sdk" >> buildozer.spec
            fi

            if grep -q "^android.ndk_path" buildozer.spec; then
              sed -i 's|^android\.ndk_path.*|android.ndk_path = /usr/local/lib/android/sdk/ndk/25.2.9519653|' buildozer.spec
            else
              echo "android.ndk_path = /usr/local/lib/android/sdk/ndk/25.2.9519653" >> buildozer.spec
            fi
          fi

      - name: Clean buildozer cache
        run: |
          rm -rf ~/.buildozer || true

      - name: Build APK (debug)
        env:
          ANDROIDSDK: /usr/local/lib/android/sdk
          ANDROID_HOME: /usr/local/lib/android/sdk
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
          ANDROIDNDK: /usr/local/lib/android/sdk/ndk/25.2.9519653
        run: |
          buildozer -v android debug

      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: apk-debug
          path: bin/*.apk
